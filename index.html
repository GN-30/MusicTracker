<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sing-to-Draw ‚Äî Modern Edition</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  :root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --text-light: #718096;
    --accent: #667eea;
    --accent-hover: #5568d3;
    --success: #48bb78;
    --danger: #f56565;
    --shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  
  * { box-sizing: border-box; }
  
  html, body { 
    height: 100%; 
    margin: 0; 
    font-family: 'Inter', system-ui, -apple-system, sans-serif; 
    background: var(--bg);
    color: var(--text-primary);
    overflow-x: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(252, 70, 107, 0.3), transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  
  .wrap { 
    display: flex; 
    flex-direction: column; 
    min-height: 100vh; 
    gap: 20px; 
    padding: 24px; 
    position: relative;
    z-index: 1;
  }
  
  header { 
    display: flex; 
    gap: 12px; 
    align-items: center; 
    flex-wrap: wrap;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 20px 24px;
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
    animation: slideDown 0.6s ease-out;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .logo {
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-right: 12px;
  }
  
  button { 
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    background: rgba(255, 255, 255, 0.95);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }
  
  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  button:hover::before {
    opacity: 0.1;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  button.primary {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
    color: white;
  }
  
  button.primary::before {
    background: white;
  }
  
  button.danger {
    background: linear-gradient(135deg, var(--danger) 0%, #e53e3e 100%);
    color: white;
  }
  
  button:disabled { 
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  button:disabled:hover {
    transform: none;
    box-shadow: var(--shadow-sm);
  }
  
  .status { 
    font-size: 14px;
    color: white;
    margin-left: auto;
    padding: 10px 18px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 500;
  }
  
  .sa-info {
    font-size: 13px;
    color: white;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .sa-info strong {
    color: #fff;
    font-weight: 600;
  }
  
  .main { 
    flex: 1; 
    display: flex; 
    gap: 20px; 
    align-items: stretch;
    animation: fadeIn 0.8s ease-out 0.2s both;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .panel-canvas { 
    flex: 1; 
    min-width: 300px;
    border-radius: 24px;
    overflow: hidden;
    background: white;
    box-shadow: var(--shadow);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
  }
  
  .panel-canvas:hover {
    transform: scale(1.01);
  }
  
  canvas#visibleCanvas { 
    width: 100%; 
    height: 100%; 
    display: block;
  }
  
  img#bgImg { 
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
    user-select: none;
  }
  
  aside.sidebar { 
    width: 380px;
    max-width: 40%;
    min-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .card { 
    padding: 24px;
    border-radius: 20px;
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 24px 70px rgba(0, 0, 0, 0.2);
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .card-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    border-radius: 2px;
  }
  
  .small { 
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
  }
  
  .debug { 
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    color: var(--text-light);
    margin-top: 12px;
    padding: 12px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(102, 126, 234, 0.1);
  }
  
  .preview-container {
    margin-top: 12px;
    border-radius: 12px;
    overflow: hidden;
    background: #f7fafc;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .preview-container img { 
    max-width: 100%;
    display: block;
    animation: scaleIn 0.5s ease-out;
  }
  
  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }
  
  .file-upload-wrapper {
    margin-top: 12px;
    position: relative;
  }
  
  .file-upload-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    border: 2px dashed var(--accent);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    color: var(--accent);
  }
  
  .file-upload-label:hover {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    border-color: var(--accent-hover);
    transform: translateY(-2px);
  }
  
  input[type=file] { 
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  
  .button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  
  .button-group button {
    flex: 1;
    min-width: 120px;
    padding: 10px 16px;
    font-size: 13px;
  }
  
  footer { 
    text-align: center;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
    padding: 20px 0;
    font-weight: 500;
  }
  
  .pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  
  @media (max-width: 900px) {
    .wrap { padding: 16px; gap: 16px; }
    
    header {
      padding: 16px;
      border-radius: 16px;
    }
    
    .logo { font-size: 20px; margin-right: 8px; }
    
    .main { 
      flex-direction: column-reverse;
    }
    
    aside.sidebar { 
      width: 100%;
      max-width: none;
      min-width: 0;
    }
    
    .panel-canvas { 
      height: 50vh;
      min-height: 300px;
    }
    
    button { 
      font-size: 15px;
      padding: 14px 20px;
    }
    
    .status {
      width: 100%;
      margin-left: 0;
      text-align: center;
    }
  }
  
  @media (pointer: coarse) {
    button { 
      min-height: 48px;
      min-width: 64px;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">üéµ Sing-to-Draw</div>
    <button id="startBtn" class="primary">Start Mic</button>
    <button id="stopBtn" class="danger" disabled>Stop Mic</button>
    <button id="setSaBtn" disabled>Set Sa</button>
    <button id="clearBtn">Clear Canvas</button>
    <div class="status" id="status">Pitch: ‚Äî Hz | Swara: ‚Äî</div>
    <div class="sa-info">Sa: <strong id="saInfo">not set</strong></div>
  </header>

  <div class="main">
    <div class="panel-canvas">
      <img id="bgImg" src="https://i.imgur.com/8Km9tLL.png" alt="background" crossorigin="anonymous"/>
      <canvas id="visibleCanvas" width="1000" height="700" aria-label="Drawing area"></canvas>
    </div>

    <aside class="sidebar">
      <div class="card">
        <h3 class="card-title">How to Use</h3>
        <div class="small">
          <strong>1.</strong> Upload a background image (recommended)<br>
          <strong>2.</strong> Start Mic ‚Üí sing sustained tonic ‚Üí Set Sa<br>
          <strong>3.</strong> Sing phrases to draw<br>
          <strong>4.</strong> Stop Mic to create & download your art
        </div>

        <div class="file-upload-wrapper">
          <label class="file-upload-label">
            üìÅ Choose Background Image
            <input id="bgUpload" type="file" accept="image/*" />
          </label>
        </div>

        <div class="button-group">
          <button id="exportBtn">Export Image</button>
          <button id="downloadBtn" disabled>Download</button>
        </div>

        <div class="debug" id="debug">RMS: ‚Äî | Conf: ‚Äî | SR: ‚Äî</div>
      </div>

      <div class="card">
        <h3 class="card-title">Preview</h3>
        <div class="small">Your masterpiece will appear here after stopping or exporting.</div>
        <div class="preview-container" id="previewArea">
          <div class="small" style="color: #a0aec0;">No artwork yet</div>
        </div>
      </div>

      <div class="card">
        <div class="small">
          üí° <strong>Tip:</strong> Works best on modern browsers with HTTPS. Upload a local background to avoid CORS issues.
        </div>
      </div>
    </aside>
  </div>

  <footer>‚ú® Sing-to-Draw ‚Äî Create art with your voice</footer>
</div>

<script>
/* ---------- Configuration & state ---------- */
const VIEW_W = 1000, VIEW_H = 700;
const semitoneToSwara = {0:'Sa',1:'Ri1',2:'Ri2',3:'Ga2',4:'Ga3',5:'Ma',6:'Ma#',7:'Pa',8:'Da1',9:'Da2',10:'Ni2',11:'Ni3'};
const swaraPoints = {
  'Sa':[ {x:0.5,y:0.10} ], 'Ri1':[ {x:0.64,y:0.20} ], 'Ri2':[ {x:0.80,y:0.36} ], 'Ga2':[ {x:0.76,y:0.54} ],
  'Ga3':[ {x:0.60,y:0.72} ], 'Ma':[ {x:0.40,y:0.74} ], 'Ma#':[ {x:0.22,y:0.56} ], 'Pa':[ {x:0.16,y:0.32} ],
  'Da1':[ {x:0.28,y:0.18} ], 'Da2':[ {x:0.48,y:0.34} ], 'Ni2':[ {x:0.36,y:0.44} ], 'Ni3':[ {x:0.44,y:0.44} ]
};

let audioCtx=null, analyser=null, source=null, mediaStream=null;
let bufferLen = 2048, dataArray = null, isRunning=false;
let SaFreq = null, lastEmittedTime = 0;
const minEmitInterval = 500, stabilityFramesNeeded = 2;
let recentSwaraHistory = [];

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const setSaBtn = document.getElementById('setSaBtn');
const clearBtn  = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const downloadBtn = document.getElementById('downloadBtn');
const bgUpload   = document.getElementById('bgUpload');
const statusEl = document.getElementById('status');
const saInfo = document.getElementById('saInfo');
const debugEl = document.getElementById('debug');
const previewArea = document.getElementById('previewArea');
const bgImg = document.getElementById('bgImg');

const visibleCanvas = document.getElementById('visibleCanvas');
const vctx = visibleCanvas.getContext('2d');

/* offscreen drawing canvas (hidden) for recording strokes */
const offscreen = document.createElement('canvas');
offscreen.width = VIEW_W;
offscreen.height = VIEW_H;
const offctx = offscreen.getContext('2d');

/* logical drawing state */
let drawnPoints = [];

/* ensure visible canvas crispness on DPR */
function adjustVisibleCanvasForDPR(){
  const rect = visibleCanvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  visibleCanvas.width = Math.round(rect.width * dpr);
  visibleCanvas.height = Math.round(rect.height * dpr);
  vctx.setTransform(dpr,0,0,dpr,0,0);
  vctx.clearRect(0,0,rect.width,rect.height);
}
window.addEventListener('resize', adjustVisibleCanvasForDPR);
adjustVisibleCanvasForDPR();

/* ---------- Drawing helpers (offscreen only) ---------- */
function clearDrawingState(){
  drawnPoints = [];
  offctx.clearRect(0,0,VIEW_W,VIEW_H);
  vctx.clearRect(0,0,visibleCanvas.width / (window.devicePixelRatio||1), visibleCanvas.height / (window.devicePixelRatio||1));
  previewArea.innerHTML = '<div class="small" style="color: #a0aec0;">No artwork yet</div>';
  downloadBtn.disabled = true;
}
clearBtn.addEventListener('click', () => {
  clearDrawingState();
});

/* draw to offscreen (hidden) canvas only */
function drawToOffscreen(x,y,swara){
  offctx.beginPath(); offctx.arc(x,y,8,0,Math.PI*2); offctx.fillStyle='rgba(255,120,40,0.95)'; offctx.fill();
  if (drawnPoints.length>0){
    const p = drawnPoints[drawnPoints.length-1];
    offctx.beginPath(); offctx.moveTo(p.x,p.y); offctx.lineTo(x,y); offctx.lineWidth=5; offctx.strokeStyle='rgba(60,120,220,0.9)'; offctx.stroke();
  }
  drawnPoints.push({x,y,swara});
}
function choosePointForSwara(swara){
  const pts = swaraPoints[swara]; if (!pts || pts.length===0) return null;
  const used = drawnPoints.filter(d=>d.swara===swara).length;
  const idx = used % pts.length;
  const norm = pts[idx];
  const x = norm.x * VIEW_W, y = norm.y * VIEW_H;
  drawToOffscreen(x,y,swara);
  return {x,y};
}

/* ---------- YIN pitch detection (compact) ---------- */
function YIN_detector(buf, sampleRate){
  const threshold = 0.12;
  const N = buf.length;
  const maxLag = Math.floor(N/2);
  const df = new Float32Array(maxLag+1);
  for (let tau=1;tau<=maxLag;tau++){
    let s=0;
    for (let i=0;i<maxLag;i++){ const d=buf[i]-buf[i+tau]; s+=d*d; }
    df[tau]=s;
  }
  const dcn = new Float32Array(maxLag+1); dcn[0]=1; let run=0;
  for (let tau=1;tau<=maxLag;tau++){ run+=df[tau]; dcn[tau]=df[tau]*tau/(run||1e-8); }
  let tauEst=-1;
  for (let tau=1;tau<=maxLag;tau++){
    if (dcn[tau] < threshold){ while (tau+1<=maxLag && dcn[tau+1]<dcn[tau]) tau++; tauEst=tau; break; }
  }
  if (tauEst===-1) return null;
  const better = parabolicInterpolation(dcn,tauEst);
  const freq = sampleRate / better;
  const confidence = Math.max(0,1-dcn[tauEst]);
  return {f:freq, prob:confidence, dcn:dcn[tauEst]};
}
function parabolicInterpolation(arr,tau){
  const x0=Math.max(0,tau-1), x2=Math.min(arr.length-1,tau+1);
  if (x0===tau||x2===tau) return tau;
  const s0=arr[x0], s1=arr[tau], s2=arr[x2]; const denom=(s0+s2-2*s1);
  if (Math.abs(denom)<1e-10) return tau; return tau + (s0 - s2)/(2*denom);
}
function freqToMidi(freq){ return 69 + 12 * Math.log2(freq/440); }
function semitoneFromSa(freq){ if (!SaFreq) return null; const midi=freqToMidi(freq), midiSa=freqToMidi(SaFreq); const rel=Math.round(midi - midiSa); const semitone = ((rel%12)+12)%12; return {rel,semitone}; }

/* ---------- audio control ---------- */
async function startMic(){
  if (isRunning) return;
  try {
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    source = audioCtx.createMediaStreamSource(mediaStream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = bufferLen;
    source.connect(analyser);
    dataArray = new Float32Array(analyser.fftSize);
    isRunning = true;
    startBtn.disabled = true; stopBtn.disabled = false; setSaBtn.disabled = false;
    debugEl.innerText = `RMS: ‚Äî | Conf: ‚Äî | SR: ${audioCtx.sampleRate}`;
    vctx.clearRect(0,0,visibleCanvas.width / (window.devicePixelRatio||1), visibleCanvas.height / (window.devicePixelRatio||1));
    adjustVisibleCanvasForDPR();
    requestAnimationFrame(tick);
  } catch (e){ console.error('startMic failed', e); alert('Microphone start failed: ' + (e && e.message?e.message:String(e))); }
}
startBtn.addEventListener('click', startMic);

async function stopMic(){
  isRunning = false;
  try { if (mediaStream) { mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } } catch(e){ console.warn(e); }
  try { if (audioCtx) { await audioCtx.close(); audioCtx=null; } } catch(e){ console.warn(e); }
  analyser = null; source = null; dataArray = null;
  startBtn.disabled = false; stopBtn.disabled = true; setSaBtn.disabled = true;
  statusEl.innerText = 'Pitch: ‚Äî Hz | Swara: ‚Äî'; debugEl.innerText = 'RMS: ‚Äî | Conf: ‚Äî | SR: ‚Äî';
  try {
    const url = await composeExportImage();
    showPreviewAndEnableDownload(url);
  } catch (err) {
    console.error('Auto export failed', err);
    previewArea.innerHTML = '<div class="small" style="color: #f56565;">Export failed ‚Äî try uploading a local background image</div>';
  }
}
stopBtn.addEventListener('click', stopMic);

/* Set Sa */
setSaBtn.addEventListener('click', async ()=>{
  if (!isRunning){ alert('Start Mic first'); return; }
  const ok = confirm('Ready to capture Sa? Sing sustained Sa (~1.5s) then press OK.');
  if (!ok) return;
  setSaBtn.disabled = true; setSaBtn.textContent='Sampling...';
  if (audioCtx && audioCtx.state==='suspended') try{ await audioCtx.resume(); }catch(e){console.warn(e);}
  try {
    const f = await captureSa();
    if (f){ SaFreq=f; saInfo.textContent = SaFreq.toFixed(2)+' Hz'; recentSwaraHistory=[]; alert('Sa set to '+SaFreq.toFixed(2)+' Hz'); }
    else alert('Could not detect stable Sa ‚Äî try again.');
  } catch(e){ console.error(e); alert('Error capturing Sa: '+(e&&e.message?e.message:String(e))); }
  finally { setSaBtn.disabled = false; setSaBtn.textContent='Set Sa'; }
});
async function captureSa(){
  if (!isRunning || !analyser) return null;
  const samples = []; const total=1600, step=120, rounds=Math.ceil(total/step);
  for (let i=0;i<rounds;i++){
    await new Promise(r=>setTimeout(r, step));
    if (!analyser) break;
    analyser.getFloatTimeDomainData(dataArray);
    const yin = YIN_detector(dataArray, audioCtx.sampleRate);
    if (yin && yin.f && yin.prob > 0.2) samples.push(yin.f);
  }
  if (samples.length < Math.max(3, Math.floor(rounds/4))) return null;
  samples.sort((a,b)=>a-b); return samples[Math.floor(samples.length/2)];
}

/* background upload (avoids CORS taint) */
bgUpload.addEventListener('change', ev=>{
  const f = ev.target.files && ev.target.files[0]; if (!f) return;
  const url = URL.createObjectURL(f);
  bgImg.removeAttribute('crossorigin'); bgImg.src = url;
  bgImg.onload = ()=>{ /* ready */ };
  bgImg.onerror = ()=>{ alert('Failed to load chosen image'); };
});

/* compose export image (bg + offscreen drawing) */
async function composeExportImage(){
  const out = document.createElement('canvas'); out.width = VIEW_W; out.height = VIEW_H;
  const octx = out.getContext('2d');
  await ensureImageLoaded(bgImg);
  const iw = bgImg.naturalWidth, ih = bgImg.naturalHeight;
  if (iw===0||ih===0) throw new Error('Background not loaded');
  const scale = Math.max(VIEW_W/iw, VIEW_H/ih);
  const sw = VIEW_W/scale, sh = VIEW_H/scale;
  const sx = (iw - sw)/2, sy = (ih - sh)/2;
  octx.drawImage(bgImg, sx, sy, sw, sh, 0,0, VIEW_W, VIEW_H);
  octx.drawImage(offscreen, 0,0, VIEW_W, VIEW_H);
  try {
    return out.toDataURL('image/png');
  } catch(e){ throw e; }
}
function ensureImageLoaded(img){ return new Promise((res,rej)=>{ if (img.complete && img.naturalWidth) return res(); const onl=()=>{ cleanup(); res(); }, one=()=>{ cleanup(); rej(new Error('bg load error')); }; function cleanup(){ img.removeEventListener('load', onl); img.removeEventListener('error', one); } img.addEventListener('load', onl); img.addEventListener('error', one); }); }

/* preview & download */
function showPreviewAndEnableDownload(dataUrl){
  previewArea.innerHTML = ''; const img = document.createElement('img'); img.src = dataUrl; previewArea.appendChild(img);
  downloadBtn.disabled = false; downloadBtn.onclick = ()=>{ const a=document.createElement('a'); a.href=dataUrl; a.download = `sing-draw-${new Date().toISOString().replace(/[:.]/g,'-')}.